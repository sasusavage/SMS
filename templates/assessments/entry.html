{% extends "layouts/dashboard.html" %}

{% block title %}Assessment Entry - {{ class_subject.subject.name }} - NaCCA SMS{% endblock %}

{% block breadcrumb %}
<nav class="breadcrumb">
    <a href="{{ url_for('dashboard.index') }}">Dashboard</a>
    <span class="breadcrumb-separator">/</span>
    <a href="{{ url_for('assessments.index') }}">Assessments</a>
    <span class="breadcrumb-separator">/</span>
    <span class="breadcrumb-current">{{ class_subject.class_.name }} - {{ class_subject.subject.name }}</span>
</nav>
{% endblock %}

{% block content %}
<div class="page-header">
    <h1 class="page-title">Enter Assessment Scores</h1>
    <p class="page-subtitle">
        {{ class_subject.class_.name }} | {{ class_subject.subject.name }} |
        {{ current_term.name if current_term else '' }}
    </p>
</div>

<!-- NaCCA Components Guide -->
<div class="card" style="margin-bottom: var(--space-6);">
    <div class="card-body">
        <div style="display: grid; grid-template-columns: repeat(5, 1fr); gap: var(--space-4); text-align: center;">
            <div style="padding: var(--space-3); background: rgba(99, 102, 241, 0.1); border-radius: var(--radius-lg);">
                <div style="font-size: var(--font-size-xl); font-weight: 700; color: var(--primary-400);">30%</div>
                <div style="font-size: var(--font-size-xs); color: var(--slate-400);">Class Work</div>
            </div>
            <div style="padding: var(--space-3); background: rgba(16, 185, 129, 0.1); border-radius: var(--radius-lg);">
                <div style="font-size: var(--font-size-xl); font-weight: 700; color: var(--success-500);">10%</div>
                <div style="font-size: var(--font-size-xs); color: var(--slate-400);">Homework</div>
            </div>
            <div style="padding: var(--space-3); background: rgba(245, 158, 11, 0.1); border-radius: var(--radius-lg);">
                <div style="font-size: var(--font-size-xl); font-weight: 700; color: var(--warning-500);">10%</div>
                <div style="font-size: var(--font-size-xs); color: var(--slate-400);">Project</div>
            </div>
            <div style="padding: var(--space-3); background: rgba(239, 68, 68, 0.1); border-radius: var(--radius-lg);">
                <div style="font-size: var(--font-size-xl); font-weight: 700; color: var(--error-500);">50%</div>
                <div style="font-size: var(--font-size-xs); color: var(--slate-400);">Exam</div>
            </div>
            <div style="padding: var(--space-3); background: var(--slate-800); border-radius: var(--radius-lg);">
                <div style="font-size: var(--font-size-xl); font-weight: 700; color: var(--slate-100);">100%</div>
                <div style="font-size: var(--font-size-xs); color: var(--slate-400);">Total</div>
            </div>
        </div>
    </div>
</div>

<form method="POST" action="{{ url_for('assessments.entry', class_subject_id=class_subject.id) }}">
    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">

    <div class="card">
        <div class="card-body" style="padding: 0;">
            <div class="table-wrapper">
                <table class="table">
                    <thead>
                        <tr>
                            <th style="width: 50px;">#</th>
                            <th style="width: 250px;">Student</th>
                            <th style="width: 100px;">Class Work (30)</th>
                            <th style="width: 100px;">Homework (10)</th>
                            <th style="width: 100px;">Project (10)</th>
                            <th style="width: 100px;">Exam (50)</th>
                            <th style="width: 80px;">Total</th>
                            <th style="width: 60px;">Grade</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for enrollment in enrollments %}
                        {% set student = enrollment.student %}
                        {% set assessment = assessments.get(student.id) %}
                        <tr data-student-id="{{ student.id }}">
                            <td>{{ loop.index }}</td>
                            <td style="font-weight: 500;">
                                <input type="hidden" name="student_ids[]" value="{{ student.id }}">
                                {{ student.full_name }}
                            </td>
                            <td>
                                <input type="number" name="classwork_{{ student.id }}" class="form-input score-input"
                                    style="padding: var(--space-2); height: 36px;" step="0.5" min="0" max="30"
                                    value="{{ assessment.classwork_score if assessment else '' }}" data-max="30"
                                    data-type="classwork">
                            </td>
                            <td>
                                <input type="number" name="homework_{{ student.id }}" class="form-input score-input"
                                    style="padding: var(--space-2); height: 36px;" step="0.5" min="0" max="10"
                                    value="{{ assessment.homework_score if assessment else '' }}" data-max="10"
                                    data-type="homework">
                            </td>
                            <td>
                                <input type="number" name="project_{{ student.id }}" class="form-input score-input"
                                    style="padding: var(--space-2); height: 36px;" step="0.5" min="0" max="10"
                                    value="{{ assessment.project_score if assessment else '' }}" data-max="10"
                                    data-type="project">
                            </td>
                            <td>
                                <input type="number" name="exam_{{ student.id }}" class="form-input score-input"
                                    style="padding: var(--space-2); height: 36px;" step="0.5" min="0" max="50"
                                    value="{{ assessment.exam_score if assessment else '' }}" data-max="50"
                                    data-type="exam">
                            </td>
                            <td class="total-cell" style="font-weight: 700;">
                                {{ assessment.total_score if assessment else '-' }}
                            </td>
                            <td class="grade-cell" style="font-weight: 700; color: var(--primary-400);">
                                {{ assessment.grade if assessment else '-' }}
                            </td>
                        </tr>
                        {% else %}
                        <tr>
                            <td colspan="8"
                                style="text-align: center; padding: var(--space-8); color: var(--slate-500);">
                                No students enrolled in this class
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
        <div class="card-footer" style="display: flex; justify-content: flex-end; gap: var(--space-3);">
            <a href="{{ url_for('assessments.index') }}" class="btn btn-ghost">Cancel</a>
            <button type="submit" class="btn btn-primary">Save Scores</button>
        </div>
    </div>
</form>

<script>
    // Auto-calculate totals and grades
    document.querySelectorAll('.score-input').forEach(input => {
        input.addEventListener('input', function () {
            const row = this.closest('tr');
            const classwork = parseFloat(row.querySelector('[data-type="classwork"]').value) || 0;
            const homework = parseFloat(row.querySelector('[data-type="homework"]').value) || 0;
            const project = parseFloat(row.querySelector('[data-type="project"]').value) || 0;
            const exam = parseFloat(row.querySelector('[data-type="exam"]').value) || 0;

            const total = classwork + homework + project + exam;
            row.querySelector('.total-cell').textContent = total.toFixed(1);

            // Calculate grade based on NaCCA scale
            let grade = '-';
            if (total >= 80) grade = '1';
            else if (total >= 70) grade = '2';
            else if (total >= 60) grade = '3';
            else if (total >= 50) grade = '4';
            else if (total >= 40) grade = '5';
            else if (total >= 30) grade = '6';
            else if (total >= 25) grade = '7';
            else if (total >= 20) grade = '8';
            else if (total >= 0) grade = '9';

            row.querySelector('.grade-cell').textContent = grade;
        });
    });
</script>
{% endblock %}